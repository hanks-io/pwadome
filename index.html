<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Demo</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./style.css">
    <meta name="theme-color" content="#4A90E2">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>
<body>
    <div class="container">
        <h1>PWA ç¤ºä¾‹</h1>
        <p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ PWA åº”ç”¨æ¼”ç¤º</p>
        
        <!-- å®‰è£…æŒ‰é’®ç»„ -->
        <div class="button-group">
            <button id="installBtn" class="install-button" style="display: none;">
                <span class="icon">ğŸ“±</span>
                å®‰è£…åˆ°ä¸»å±å¹•
            </button>
            
            <button id="shareBtn" class="share-button">
                <span class="icon">ğŸ”„</span>
                åˆ·æ–°é¡µé¢
            </button>
            
            <button id="openNewBtn" class="open-new-button">
                <span class="icon">ğŸ”—</span>
                æ‰“å¼€ç™¾åº¦
            </button>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let serviceWorkerRegistration = null;
        const installBtn = document.getElementById('installBtn');
        const shareBtn = document.getElementById('shareBtn');
        const openNewBtn = document.getElementById('openNewBtn');

        // Service Worker æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ');
                    serviceWorkerRegistration = registration;
                    
                    // ç¡®ä¿ Service Worker æ¿€æ´»
                    if (registration.active) {
                        console.log('Service Worker å·²æ¿€æ´»');
                    } else {
                        registration.addEventListener('activate', () => {
                            console.log('Service Worker å·²æ¿€æ´»');
                        });
                    }
                })
                .catch(error => {
                    console.error('ServiceWorker æ³¨å†Œå¤±è´¥:', error);
                });
        }

        // ç›‘å¬ Service Worker æ¶ˆæ¯
        navigator.serviceWorker.addEventListener('message', event => {
            console.log('æ”¶åˆ° Service Worker æ¶ˆæ¯:', event.data);
            
            if (!event.data || !event.data.type) return;

            switch (event.data.type) {
                case 'HANDLE_NAVIGATION':
                    console.log('å¤„ç†å¯¼èˆªè¯·æ±‚:', event.data.url);
                    window.location.href = '?url=' + encodeURIComponent(event.data.url);
                    break;

                case 'NAVIGATION_ERROR':
                    console.error('å¯¼èˆªé”™è¯¯:', event.data.error);
                    alert('å¯¼èˆªå¤±è´¥: ' + event.data.error);
                    break;
            }
        });

        // PWA å®‰è£…å¤„ç†
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`ç”¨æˆ·é€‰æ‹©: ${outcome}`);
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });

        // åˆ·æ–°æŒ‰é’®å¤„ç†
        shareBtn.addEventListener('click', () => {
            window.location.reload();
        });

        // æ‰“å¼€æ–°é¡µé¢å¤„ç†
        openNewBtn.addEventListener('click', async () => {
            console.log('ç‚¹å‡»æ‰“å¼€æŒ‰é’®');
            
            if (!navigator.serviceWorker.controller) {
                console.log('Service Worker æœªæ§åˆ¶é¡µé¢ï¼Œç­‰å¾…æ¿€æ´»...');
                // ç­‰å¾… Service Worker æ¿€æ´»
                if (serviceWorkerRegistration) {
                    await serviceWorkerRegistration.active;
                }
            }

            if (navigator.serviceWorker.controller) {
                console.log('å‘é€å¯¼èˆªæ¶ˆæ¯åˆ° Service Worker');
                navigator.serviceWorker.controller.postMessage({
                    type: 'NAVIGATE',
                    url: 'https://pwa.qu6.xyz'
                });
            } else {
                console.log('é™çº§å¤„ç†ï¼šç›´æ¥å¯¼èˆª');
                window.location.href = '?url=' + encodeURIComponent('https://www.baidu.com');
            }
        });

        // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ PWA ç¯å¢ƒä¸­
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('å½“å‰åœ¨ PWA ç¯å¢ƒä¸­è¿è¡Œ');
        }
    </script>
</body>
</html> 