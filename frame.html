<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA View</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #content {
            flex: 1;
            width: 100%;
            height: calc(100% - 44px);
            overflow: auto;
            position: relative;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 2px solid #4A90E2;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }

        /* 自定义滚动条 */
        #content::-webkit-scrollbar {
            width: 8px;
        }

        #content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="content"></div>
        <div class="loading">加载中...</div>
        <div id="error">加载失败，正在返回首页...</div>
    </div>

    <script>
        const content = document.getElementById('content');
        const loading = document.querySelector('.loading');
        const error = document.getElementById('error');

        // 获取 URL 参数
        const params = new URLSearchParams(window.location.search);
        const url = params.get('url');

        if (url) {
            loadContent(url);
        } else {
            goHome();
        }

        async function loadContent(url) {
            try {
                loading.style.display = 'block';
                error.style.display = 'none';

                // 使用 fetch 获取内容
                const response = await fetch(url);
                const text = await response.text();

                // 创建一个临时容器来解析 HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');

                // 移除不需要的元素
                const elementsToRemove = doc.querySelectorAll('header, nav, footer, .header, .nav, .navbar');
                elementsToRemove.forEach(el => el.remove());

                // 提取主要内容
                const mainContent = doc.querySelector('main') || doc.querySelector('#main') || doc.querySelector('.main') || doc.body;

                // 修改所有链接
                const links = mainContent.querySelectorAll('a');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && !href.startsWith('#')) {
                        const absoluteUrl = new URL(href, url).href;
                        link.setAttribute('href', '#');
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadContent(absoluteUrl);
                        });
                    }
                });

                // 注入内容
                content.innerHTML = '';
                content.appendChild(mainContent);

                // 处理样式
                const styles = doc.querySelectorAll('style, link[rel="stylesheet"]');
                styles.forEach(style => document.head.appendChild(style.cloneNode(true)));

                // 处理脚本
                const scripts = mainContent.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });

                loading.style.display = 'none';

                // 更新历史记录
                window.history.pushState({ url }, '', `?url=${encodeURIComponent(url)}`);
            } catch (e) {
                console.error('加载失败:', e);
                error.style.display = 'block';
                loading.style.display = 'none';
                setTimeout(goHome, 2000);
            }
        }

        function goHome() {
            window.location.href = './';
        }

        // 处理浏览器后退/前进
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.url) {
                loadContent(event.state.url);
            } else {
                goHome();
            }
        });

        // 处理 PWA 环境
        if (window.matchMedia('(display-mode: standalone)').matches) {
            document.body.classList.add('standalone');
        }
    </script>
</body>
</html> 